<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="title">Investment Simulator - JugendInvestiert</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- TradingView Widget -->
    <script src="https://s3.tradingview.com/tv.js"></script>
    <!-- Chart.js (v3.9.1 as specified) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }
        html, body {
            font-family: 'Poppins', Arial, sans-serif;
            margin: 0;
            padding: 0 0 30px 0;
            background-color: #101820;
            color: white;
            overflow-x: hidden;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
        .navbar {
            background-color: #1B2631;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        .navbar .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .navbar img {
            height: 50px;
            width: 50px;
            border-radius: 10px;
        }
        .navbar h1 {
            font-size: 24px;
            margin: 0;
            font-weight: bold;
        }
        .container {
            display: flex;
            flex-direction: column;
            padding: 15px 15px 30px 30px;
            gap: 15px;
            margin-top: 80px;
            align-items: center;
            max-width: 100%;
        }
        .account-summary {
            background-color: #1B2631;
            padding: 10px;
            border-radius: 15px;
            display: flex;
            justify-content: space-around;
            text-align: center;
            width: 100%;
            max-width: 1200px;
            gap: 10px;
        }
        .account-summary .summary-item {
            flex: 1;
            min-width: 100px;
            background-color: #273746;
            padding: 10px;
            border-radius: 10px;
        }
        .account-summary .summary-item h3 {
            font-size: 0.9rem;
            font-weight: 400;
            color: #cccccc;
            margin-bottom: 5px;
        }
        .account-summary .summary-item p {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
            color: #007bff;
        }
        .total-profit {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .profit-positive {
            color: #4caf50;
        }
        .profit-negative {
            color: #f44336;
        }
        .trade-widget-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 1200px;
        }
        .trade-section {
            background-color: #1B2631;
            padding: 15px;
            border-radius: 15px;
            flex: 1;
            min-width: 300px;
            max-width: 600px;
            box-sizing: border-box;
            order: 1;
            position: relative;
        }
        .trade-section h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-align: center;
        }
        .trade-section label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #cccccc;
            text-align: left;
        }
        .search-container {
            position: relative;
        }
        .trade-section input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #2e2e2e;
            border-radius: 5px;
            background-color: #101820;
            color: #ffffff;
            font-size: 1rem;
        }
        .trade-section input::placeholder {
            color: #555;
        }
        .trade-section input:focus {
            outline: none;
            border-color: #007bff;
        }
        #buy-button {
            width: 100%;
            padding: 15px;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            color: #ffffff;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            margin-top: 10px;
        }
        #buy-button:hover {
            background-color: #0056b3;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
        }
        #suggestions {
            background-color: #1B2631;
            border: 1px solid #2e2e2e;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            z-index: 10;
            display: none;
        }
        .suggestion-item {
            padding: 10px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #2e2e2e;
        }
        .suggestion-item strong {
            color: #ffffff;
        }
        #tradingview-widget {
            border: none;
            box-shadow: none;
            border-radius: 15px;
            overflow: hidden;
            flex: 1;
            min-width: 300px;
            height: 400px;
            max-width: 600px;
            display: block;
            order: 2;
            background-color: #1B2631;
            padding: 0;
            margin-bottom: 0;
        }
        .portfolio-section {
            background-color: #1B2631;
            padding: 15px;
            border-radius: 15px;
            width: 100%;
            max-width: 1200px;
            box-sizing: border-box;
            overflow-x: auto;
        }
        .portfolio-section h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-align: center;
        }
        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        .portfolio-table th, .portfolio-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #2e2e2e;
            font-size: 0.9rem;
        }
        .portfolio-table th {
            color: #cccccc;
            font-weight: 700;
        }
        .portfolio-table td {
            font-size: 0.9rem;
        }
        .portfolio-table button {
            padding: 8px 12px;
            background-color: #f44336;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            width: auto;
        }
        .portfolio-table button:hover {
            background-color: #d32f2f;
        }
        .portfolio-table th:last-child,
        .portfolio-table td:last-child {
            position: sticky;
            right: 0;
            background-color: #1B2631;
            z-index: 2;
            box-shadow: -1px 0 3px rgba(0, 0, 0, 0.3);
        }
        .portfolio-analysis-section {
            background-color: #1B2631;
            padding: 15px;
            border-radius: 15px;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 15px;
        }
        .portfolio-analysis-section h2 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: 700;
            text-align: center;
        }
        .analysis-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
        }
        .tab-button {
            padding: 8px 15px;
            background-color: #273746;
            border: none;
            border-radius: 5px;
            color: #cccccc;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        .tab-button:hover {
            background-color: #0056b3;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 20px;
        }
        .chart-wrapper {
            background-color: #273746;
            border-radius: 10px;
            padding: 15px;
            flex: 1;
            min-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-wrapper h3 {
            font-size: 1.1rem;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            color: #cccccc;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .analysis-summary {
            background-color: #273746;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        .analysis-summary h3 {
            font-size: 1.1rem;
            margin-top: 0;
            margin-bottom: 10px;
            color: #cccccc;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .summary-item-analysis {
            background-color: #1B2631;
            padding: 10px;
            border-radius: 8px;
        }
        .summary-item-analysis h4 {
            font-size: 0.9rem;
            margin: 0 0 5px 0;
            color: #cccccc;
        }
        .summary-item-analysis p {
            font-size: 1.1rem;
            margin: 0;
            font-weight: 700;
        }
        .sparkline-container {
            height: 40px;
            margin-top: 5px;
        }
        .message {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #1B2631;
            padding: 10px;
            border-radius: 5px;
            color: #fff;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeInOut 4s forwards;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-size: 0.9rem;
        }
        .message i {
            font-size: 1.2rem;
        }
        .message.success {
            border-left: 5px solid #4caf50;
        }
        .message.error {
            border-left: 5px solid #f44336;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        #loader {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #007bff;
            font-size: 2rem;
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4000;
        }
        .popup-content {
            background-color: #1B2631;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .popup-content h2 {
            margin-top: 0;
            font-size: 1.5rem;
        }
        .popup-content p {
            font-size: 1rem;
            margin-bottom: 20px;
        }
        .language-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .language-button {
            padding: 10px 20px;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            color: #ffffff;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .language-button:hover {
            background-color: #0056b3;
        }
        .continue-button {
            padding: 10px 20px;
            background-color: #4caf50;
            border: none;
            border-radius: 5px;
            color: #ffffff;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .continue-button:hover {
            background-color: #388e3c;
        }
        @media screen and (max-width: 768px) {
            .navbar {
                padding: 10px;
            }
            .navbar img {
                height: 40px;
                width: 40px;
            }
            .navbar h1 {
                font-size: 20px;
            }
            .container {
                margin-top: 70px;
                padding: 10px 10px 30px 10px;
            }
            .account-summary {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
                gap: 5px;
                max-width: 600px;
            }
            .trade-widget-container {
                flex-direction: column;
                max-width: 600px;
            }
            .trade-section {
                order: 2;
                padding: 10px;
                max-width: 600px;
            }
            #tradingview-widget {
                order: 1;
                margin-bottom: 0;
                width: 100%;
                height: 300px;
                max-width: 600px;
                padding: 0;
            }
            .portfolio-section {
                padding: 10px;
            }
            .portfolio-section h2 {
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
            .portfolio-table th, .portfolio-table td {
                padding: 6px;
                font-size: 0.8rem;
            }
            .portfolio-table th:last-child,
            .portfolio-table td:last-child {
                position: static;
                box-shadow: none;
            }
            .portfolio-table button {
                width: 100%;
                box-sizing: border-box;
            }
            .charts-container {
                flex-direction: column;
            }
            .chart-wrapper {
                min-width: 100%;
            }
            .chart-container {
                height: 200px;
            }
            .summary-grid {
                grid-template-columns: 1fr;
            }
            .analysis-tabs {
                flex-wrap: wrap;
            }
            .portfolio-analysis-section h2 {
                font-size: 1.2rem;
            }
            .tab-button {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
            .popup-content {
                width: 95%;
                padding: 15px;
            }
            .popup-content h2 {
                font-size: 1.3rem;
            }
            .popup-content p {
                font-size: 0.9rem;
            }
            .language-button, .continue-button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }
        @media (max-width: 480px) {
            .navbar h1 { font-size: 18px; }
            .navbar img { height: 35px; width: 35px; }
            .container { margin-top: 60px; }
            .account-summary .summary-item h3 { font-size: 0.8rem; }
            .account-summary .summary-item p { font-size: 1rem; }
            .trade-section h2, .portfolio-section h2, .portfolio-analysis-section h2 { font-size: 1.1rem; }
            .trade-section input, .trade-section button { font-size: 0.9rem; }
            .chart-wrapper h3 { font-size: 1rem; }
            .summary-item-analysis h4 { font-size: 0.8rem; }
            .summary-item-analysis p { font-size: 1rem; }
            .popup-content h2 { font-size: 1.1rem; }
            .popup-content p { font-size: 0.8rem; }
            .language-button, .continue-button { font-size: 0.8rem; padding: 6px 12px; }
        }
    </style>
</head>
<body>
    <div id="welcome-popup" class="popup-overlay" style="display: flex;">
        <div class="popup-content">
            <div class="language-buttons">
                <button class="language-button" onclick="selectLanguage('en')">English</button>
                <button class="language-button" onclick="selectLanguage('de')">Deutsch</button>
                <button class="language-button" onclick="selectLanguage('fr')">Français</button>
            </div>
            <h2 data-translate-key="welcome_title">Welcome to the Investment Simulator</h2>
            <p data-translate-key="disclaimer">This simulator is for educational purposes only and uses virtual money. No real financial transactions are involved.</p>
            <button class="continue-button" onclick="closeWelcomePopup()" data-translate-key="continue_button">Continue</button>
        </div>
    </div>
    <div class="navbar">
        <div class="logo">
            <img src="logo.jpg" alt="JugendInvestiert Logo">
            <h1 data-translate-key="brand">JugendInvestiert</h1>
        </div>
    </div>
    <div class="container">
        <div class="account-summary">
            <div class="summary-item">
                <h3 data-translate-key="portfolio_value">Portfolio Wert</h3>
                <p>$<span id="portfolioValue">0.00</span></p>
            </div>
            <div class="summary-item">
                <h3 data-translate-key="cash_balance">Bargeldsaldo</h3>
                <p>$<span id="budget">10000.00</span></p>
            </div>
            <div class="summary-item">
                <h3 data-translate-key="total_profit">Gesamter Gewinn</h3>
                <p id="totalProfit" class="total-profit">$0.00</p>
            </div>
            <div class="summary-item">
                <h3 data-translate-key="profit_loss_percent">Gewinn/Verlust %</h3>
                <p id="totalProfitPercent" class="total-profit">0.00%</p>
            </div>
        </div>
        <div class="trade-widget-container">
            <div class="trade-section" id="trade-section">
                <h2 data-translate-key="trade_stocks">Aktien Handeln</h2>
                <label for="stock-symbol" data-translate-key="stock_symbol_label">Aktiensymbol oder Firmenname</label>
                <div class="search-container">
                    <input type="text" id="stock-symbol" placeholder="z.B., AAPL, Apple Inc." autocomplete="off" onkeyup="debouncedFilterSymbols()">
                    <div id="suggestions"></div>
                </div>
                <label for="quantity" data-translate-key="quantity_label">Anzahl</label>
                <input type="number" id="quantity" placeholder="Anzahl eingeben" min="1" step="1">
                <div id="current-price" style="margin-top: 10px;">
                    <h3 data-translate-key="current_price">Aktueller Preis: $<span id="currentPrice">0.00</span></h3>
                </div>
                <button id="buy-button" onclick="buyStock()" data-translate-key="buy_button"><b>Kaufen</b></button>
            </div>
            <div id="tradingview-widget"></div>
        </div>
        <div class="portfolio-section">
            <h2 data-translate-key="portfolio_title">Dein Portfolio</h2>
            <table class="portfolio-table">
                <thead>
                    <tr>
                        <th data-translate-key="symbol">Symbol</th>
                        <th data-translate-key="quantity">Anzahl</th>
                        <th data-translate-key="purchase_price">Kaufpreis</th>
                        <th data-translate-key="current_price">Akt. Preis</th>
                        <th data-translate-key="profit_loss">Gewinn/Verlust</th>
                        <th data-translate-key="action">Aktion</th>
                    </tr>
                </thead>
                <tbody id="portfolioTableBody"></tbody>
            </table>
        </div>
        <div class="portfolio-analysis-section">
            <h2 data-translate-key="portfolio_analysis">Portfolio Analyse</h2>
            <div class="analysis-tabs">
                <button class="tab-button active" data-tab="allocation" data-translate-key="allocation">Allokation</button>
                <button class="tab-button" data-tab="performance" data-translate-key="performance">Performance</button>
                <button class="tab-button" data-tab="summary" data-translate-key="summary">Zusammenfassung</button>
            </div>
            <div id="allocation-tab" class="tab-content active">
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <h3 data-translate-key="portfolio_allocation">Portfolio Verteilung</h3>
                        <div class="chart-container">
                            <canvas id="allocation-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <h3 data-translate-key="sector_investments">Investitionen nach Sektor</h3>
                        <div class="chart-container">
                            <canvas id="sector-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div id="performance-tab" class="tab-content">
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <h3 data-translate-key="portfolio_development">Portfolio Entwicklung</h3>
                        <div class="chart-container">
                            <canvas id="performance-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <h3 data-translate-key="profit_loss_per_stock">Gewinn/Verlust pro Aktie</h3>
                        <div class="chart-container">
                            <canvas id="profit-loss-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div id="summary-tab" class="tab-content">
                <div class="analysis-summary">
                    <h3 data-translate-key="portfolio_metrics">Portfolio Kennzahlen</h3>
                    <div class="summary-grid">
                        <div class="summary-item-analysis">
                            <h4 data-translate-key="top_performer">Top-Performer</h4>
                            <p id="top-performer">-</p>
                        </div>
                        <div class="summary-item-analysis">
                            <h4 data-translate-key="worst_performer">Schwächster Performer</h4>
                            <p id="worst-performer">-</p>
                        </div>
                        <div class="summary-item-analysis">
                            <h4 data-translate-key="largest_position">Größte Position</h4>
                            <p id="largest-position">-</p>
                        </div>
                        <div class="summary-item-analysis">
                            <h4 data-translate-key="position_count">Anzahl Positionen</h4>
                            <p id="position-count">0</p>
                        </div>
                        <div class="summary-item-analysis">
                            <h4 data-translate-key="avg_position_size">Durchschn. Position</h4>
                            <p id="avg-position-size">$0.00</p>
                        </div>
                        <div class="summary-item-analysis">
                            <h4 data-translate-key="trend">Trend</h4>
                            <div class="sparkline-container">
                                <canvas id="sparkline-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="loader"><i class="fas fa-spinner fa-spin"></i></div>
    <div id="message-container"></div>
    <script>
        const translations = {
            "de": {
                "title": "Investment Simulator - JugendInvestiert",
                "brand": "JugendInvestiert",
                "welcome_title": "Willkommen zum Investment Simulator",
                "disclaimer": "Dieser Simulator dient ausschließlich zu Bildungszwecken und verwendet virtuelles Geld. Es sind keine echten Finanztransaktionen involviert.",
                "continue_button": "Weiter",
                "portfolio_value": "Portfolio Wert",
                "cash_balance": "Bargeldsaldo",
                "total_profit": "Gesamter Gewinn",
                "profit_loss_percent": "Gewinn/Verlust %",
                "trade_stocks": "Aktien Handeln",
                "stock_symbol_label": "Aktiensymbol oder Firmenname",
                "quantity_label": "Anzahl",
                "current_price": "Aktueller Preis",
                "buy_button": "Kaufen",
                "portfolio_title": "Dein Portfolio",
                "symbol": "Symbol",
                "quantity": "Anzahl",
                "purchase_price": "Kaufpreis",
                "current_price": "Akt. Preis",
                "profit_loss": "Gewinn/Verlust",
                "action": "Aktion",
                "portfolio_analysis": "Portfolio Analyse",
                "allocation": "Allokation",
                "performance": "Performance",
                "summary": "Zusammenfassung",
                "portfolio_allocation": "Portfolio Verteilung",
                "sector_investments": "Investitionen nach Sektor",
                "portfolio_development": "Portfolio Entwicklung",
                "profit_loss_per_stock": "Gewinn/Verlust pro Aktie",
                "portfolio_metrics": "Portfolio Kennzahlen",
                "top_performer": "Top-Performer",
                "worst_performer": "Schwächster Performer",
                "largest_position": "Größte Position",
                "position_count": "Anzahl Positionen",
                "avg_position_size": "Durchschn. Position",
                "trend": "Trend",
                "unknown": "Unbekannt",
                "error_stock_symbol": "Bitte gib ein Aktiensymbol ein.",
                "error_quantity": "Bitte gib eine gültige positive Anzahl ein.",
                "error_insufficient_cash": "Nicht genügend Bargeldsaldo.",
                "error_invalid_symbol": "Ungültiges Aktiensymbol oder Preis konnte nicht abgerufen werden.",
                "error_buy_stock": "Beim Kauf der Aktie ist ein Fehler aufgetreten.",
                "error_sell_stock": "Beim Verkauf der Aktie ist ein Fehler aufgetreten.",
                "error_insufficient_shares": "Nicht genügend Aktien zum Verkaufen.",
                "error_fetch_stock_list": "Fehler beim Abrufen der Aktienliste. Bitte versuche es später erneut.",
                "success_buy_stock": "Erfolgreich {quantity} Aktien von {symbol} gekauft.",
                "success_sell_stock": "Erfolgreich {quantity} Aktien von {symbol} verkauft.",
                "sell_prompt": "Gib die Anzahl der zu verkaufenden Aktien ein (Verfügbar: {totalQuantity}):"
            },
            "en": {
                "title": "Investment Simulator - YouthInvests",
                "brand": "YouthInvests",
                "welcome_title": "Welcome to the Investment Simulator",
                "disclaimer": "This simulator is for educational purposes only and uses virtual money. No real financial transactions are involved.",
                "continue_button": "Continue",
                "portfolio_value": "Portfolio Value",
                "cash_balance": "Cash Balance",
                "total_profit": "Total Profit",
                "profit_loss_percent": "Profit/Loss %",
                "trade_stocks": "Trade Stocks",
                "stock_symbol_label": "Stock Symbol or Company Name",
                "quantity_label": "Quantity",
                "current_price": "Current Price",
                "buy_button": "Buy",
                "portfolio_title": "Your Portfolio",
                "symbol": "Symbol",
                "quantity": "Quantity",
                "purchase_price": "Purchase Price",
                "current_price": "Current Price",
                "profit_loss": "Profit/Loss",
                "action": "Action",
                "portfolio_analysis": "Portfolio Analysis",
                "allocation": "Allocation",
                "performance": "Performance",
                "summary": "Summary",
                "portfolio_allocation": "Portfolio Allocation",
                "sector_investments": "Investments by Sector",
                "portfolio_development": "Portfolio Development",
                "profit_loss_per_stock": "Profit/Loss per Stock",
                "portfolio_metrics": "Portfolio Metrics",
                "top_performer": "Top Performer",
                "worst_performer": "Worst Performer",
                "largest_position": "Largest Position",
                "position_count": "Number of Positions",
                "avg_position_size": "Avg. Position Size",
                "trend": "Trend",
                "unknown": "Unknown",
                "error_stock_symbol": "Please enter a stock symbol.",
                "error_quantity": "Please enter a valid positive quantity.",
                "error_insufficient_cash": "Insufficient cash balance.",
                "error_invalid_symbol": "Invalid stock symbol or price could not be retrieved.",
                "error_buy_stock": "An error occurred while buying the stock.",
                "error_sell_stock": "An error occurred while selling the stock.",
                "error_insufficient_shares": "Not enough shares to sell.",
                "error_fetch_stock_list": "Error fetching stock list. Please try again later.",
                "success_buy_stock": "Successfully bought {quantity} shares of {symbol}.",
                "success_sell_stock": "Successfully sold {quantity} shares of {symbol}.",
                "sell_prompt": "Enter the number of shares to sell (Available: {totalQuantity}):"
            },
            "fr": {
                "title": "Simulateur d'Investissement - JeunesseInvestit",
                "brand": "JeunesseInvestit",
                "welcome_title": "Bienvenue au Simulateur d'Investissement",
                "disclaimer": "Ce simulateur est uniquement à des fins éducatives et utilise de l'argent virtuel. Aucune transaction financière réelle n'est impliquée.",
                "continue_button": "Continuer",
                "portfolio_value": "Valeur du Portefeuille",
                "cash_balance": "Solde en Espèces",
                "total_profit": "Profit Total",
                "profit_loss_percent": "Profit/Perte %",
                "trade_stocks": "Négocier des Actions",
                "stock_symbol_label": "Symbole ou Nom de l'Entreprise",
                "quantity_label": "Quantité",
                "current_price": "Prix Actuel",
                "buy_button": "Acheter",
                "portfolio_title": "Votre Portefeuille",
                "symbol": "Symbole",
                "quantity": "Quantité",
                "purchase_price": "Prix d'Achat",
                "current_price": "Prix Actuel",
                "profit_loss": "Profit/Perte",
                "action": "Action",
                "portfolio_analysis": "Analyse du Portefeuille",
                "allocation": "Allocation",
                "performance": "Performance",
                "summary": "Résumé",
                "portfolio_allocation": "Répartition du Portefeuille",
                "sector_investments": "Investissements par Secteur",
                "portfolio_development": "Développement du Portefeuille",
                "profit_loss_per_stock": "Profit/Perte par Action",
                "portfolio_metrics": "Métriques du Portefeuille",
                "top_performer": "Meilleur Performeur",
                "worst_performer": "Pire Performeur",
                "largest_position": "Position la Plus Important",
                "position_count": "Nombre de Positions",
                "avg_position_size": "Taille Moyenne de Position",
                "trend": "Tendance",
                "unknown": "Inconnu",
                "error_stock_symbol": "Veuillez entrer un symbole d'action.",
                "error_quantity": "Veuillez entrer une quantité positive valide.",
                "error_insufficient_cash": "Solde en espèces insuffisant.",
                "error_invalid_symbol": "Symbole d'action invalide ou prix non récupéré.",
                "error_buy_stock": "Une erreur s'est produite lors de l'achat de l'action.",
                "error_sell_stock": "Une erreur s'est produite lors de la vente de l'action.",
                "error_insufficient_shares": "Pas assez d'actions à vendre.",
                "error_fetch_stock_list": "Erreur lors de la récupération de la liste des actions. Veuillez réessayer plus tard.",
                "success_buy_stock": "Acheté avec succès {quantity} actions de {symbol}.",
                "success_sell_stock": "Vendu avec succès {quantity} actions de {symbol}.",
                "sell_prompt": "Entrez le nombre d'actions à vendre (Disponible : {totalQuantity}) :"
            }
        };
        const finnhubApiKey = "cs1uv71r01qpjum5l9agcs1uv71r01qpjum5l9b0";
        const firebaseConfig = {
            apiKey: "AIzaSyDmEUCl7sWzBI7N78HgcgBRcRAkTYbtm5g",
            authDomain: "jugendinvestiert-5f6eb.firebaseapp.com",
            databaseURL: "https://jugendinvestiert-5f6eb-default-rtdb.firebaseio.com",
            projectId: "jugendinvestiert-5f6eb",
            storageBucket: "jugendinvestiert-5f6eb.appspot.com",
            messagingSenderId: "432595310987",
            appId: "1:432595310987:web:fd9f7975d5e87f1fe1378e",
            measurementId: "G-5ENQC9KQBY"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let budget = 10000;
        let portfolio = {};
        let stockList = [];
        let isBuying = false;
        let currentSymbol = '';
        const initialCapital = 10000;
        let allocationChart = null;
        let sectorChart = null;
        let performanceChart = null;
        let profitLossChart = null;
        let sparklineChart = null;
        let currentLang = 'en';
        const chartColors = ['#007bff', '#4caf50', '#f44336', '#ffeb3b', '#9c27b0', '#ff5722', '#3f51b5', '#009688'];
        const stockSectors = {
            'AAPL': 'Technology',
            'MSFT': 'Technology',
            'GOOGL': 'Technology',
            'AMZN': 'Consumer Cyclical',
            'TSLA': 'Consumer Cyclical',
            'JPM': 'Financial Services',
            'V': 'Financial Services',
            'WMT': 'Consumer Defensive',
            'PG': 'Consumer Defensive',
            'XOM': 'Energy',
            'CVX': 'Energy',
            'JNJ': 'Healthcare',
            'PFE': 'Healthcare'
        };
        function showWelcomePopup() {
            document.getElementById('welcome-popup').style.display = 'flex';
            applyTranslations(currentLang);
        }
        function closeWelcomePopup() {
            document.getElementById('welcome-popup').style.display = 'none';
        }
        function selectLanguage(lang) {
            translatePage(lang);
            applyTranslations(lang);
            window.parent.postMessage({
                type: 'LANGUAGE_CHANGE',
                language: lang,
                source: 'simulator-iframe'
            }, '*');
        }
        function applyTranslations(targetLang) {
            const elements = document.querySelectorAll('[data-translate-key]');
            if (!translations[targetLang]) return;
            elements.forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (translations[targetLang][key]) {
                    element.innerHTML = translations[targetLang][key];
                }
            });
            document.title = translations[targetLang].title;
            document.documentElement.lang = targetLang;
            document.getElementById('stock-symbol').placeholder = translations[targetLang]['stock_symbol_label'];
            document.getElementById('quantity').placeholder = translations[targetLang]['quantity_label'];
            document.getElementById('buy-button').innerHTML = `<b>${translations[targetLang]['buy_button']}</b>`;
        }
        function translatePage(targetLang) {
            if (targetLang === currentLang) return;
            currentLang = targetLang;
            applyTranslations(targetLang);
            localStorage.setItem('preferredLanguage', targetLang);
            updateBudget();
            updatePortfolioTable();
            updatePortfolioAnalysis();
            if (currentSymbol) {
                createTradingViewWidget(currentSymbol);
            }
        }
        window.addEventListener('message', (event) => {
            if (event.data.type === 'AUTH_DATA') {
                console.log("Simulator received AUTH_DATA:", event.data);
                budget = typeof event.data.budget === 'number' ? event.data.budget : 10000;
                portfolio = event.data.portfolio && typeof event.data.portfolio === 'object' ? event.data.portfolio : {};
                portfolio = normalizePortfolioSymbols(portfolio);
                updateBudget();
                updatePortfolioTable();
                updatePortfolioAnalysis();
                console.log("AUTH_DATA processed.");
            } else if (event.data.type === 'LANGUAGE_CHANGE' && event.data.source !== 'simulator-iframe') {
                console.log("Simulator received LANGUAGE_CHANGE:", event.data.language);
                if (translations[event.data.language] && event.data.language !== currentLang) {
                    translatePage(event.data.language);
                }
            }
        });
        function sendPortfolioUpdate() {
            const data = {
                type: 'PORTFOLIO_UPDATE',
                budget: budget,
                portfolio: portfolio
            };
            console.log("Sending PORTFOLIO_UPDATE:", data);
            window.parent.postMessage(data, '*');
        }
        async function fetchStockList() {
            const url = `https://finnhub.io/api/v1/stock/symbol?exchange=US&token=${finnhubApiKey}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                stockList = data.map(stock => ({
                    symbol: stock.symbol.toUpperCase(),
                    description: stock.description
                }));
                console.log("Stock list fetched:", stockList.length, "stocks");
            } catch (error) {
                console.error("Error fetching stock list:", error);
                displayErrorMessage(translations[currentLang].error_fetch_stock_list);
            }
        }
        function debounce(func, delay) {
            let debounceTimer;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(context, args), delay);
            }
        }
        const debouncedFilterSymbols = debounce(filterSymbols, 300);
        function filterSymbols() {
            const input = document.getElementById('stock-symbol').value.toUpperCase();
            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML = '';
            if (input === '') {
                suggestions.style.display = 'none';
                return;
            }
            const exactMatches = stockList.filter(stock => stock.symbol === input || stock.description.toUpperCase() === input);
            const startsWithMatches = stockList.filter(stock => (stock.symbol.startsWith(input) || stock.description.toUpperCase().startsWith(input)) && !exactMatches.includes(stock));
            const includesMatches = stockList.filter(stock => (stock.symbol.includes(input) || stock.description.toUpperCase().includes(input)) && !exactMatches.includes(stock) && !startsWithMatches.includes(stock));
            const combined = [...exactMatches, ...startsWithMatches, ...includesMatches];
            const uniqueCombined = Array.from(new Set(combined.map(stock => stock.symbol))).map(symbol => combined.find(stock => stock.symbol === symbol));
            const filtered = uniqueCombined.slice(0, 5);
            if (filtered.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            filtered.forEach(stock => {
                const div = document.createElement('div');
                div.classList.add('suggestion-item');
                const boldedSymbol = boldMatch(stock.symbol, input);
                const boldedDescription = boldMatch(stock.description.toUpperCase(), input);
                div.innerHTML = `${boldedSymbol} - ${boldedDescription}`;
                div.onclick = () => selectSymbol(stock.symbol);
                suggestions.appendChild(div);
            });
            suggestions.style.display = 'block';
        }
        function boldMatch(text, input) {
            const regex = new RegExp(`(${input})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }
        async function selectSymbol(symbol) {
            symbol = symbol.toUpperCase();
            document.getElementById('stock-symbol').value = symbol;
            const price = await fetchStockPrice(symbol);
            document.getElementById('currentPrice').innerText = price > 0 ? price.toFixed(2) : "0.00";
            document.getElementById('suggestions').style.display = 'none';
            currentSymbol = symbol;
            createTradingViewWidget(symbol);
        }
        async function fetchStockPrice(symbol) {
            const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${finnhubApiKey}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (!data || typeof data.c !== 'number' || data.c <= 0) {
                    console.warn("No valid price data for symbol:", symbol);
                    return 0;
                }
                return parseFloat(data.c);
            } catch (error) {
                console.error(`Error fetching price for ${symbol}:`, error);
                displayErrorMessage(translations[currentLang].error_invalid_symbol);
                return 0;
            }
        }
        async function fetchHistoricalPrices(symbol) {
            const to = Math.floor(Date.now() / 1000);
            const from = to - 30 * 24 * 60 * 60;
            const url = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${to}&token=${finnhubApiKey}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (data.s !== 'ok' || !data.c || !data.t) {
                    console.warn(`No historical data for ${symbol}`);
                    return [];
                }
                return data.c.map((price, index) => ({
                    date: new Date(data.t[index] * 1000).toLocaleDateString(),
                    price: price
                }));
            } catch (error) {
                console.error(`Error fetching historical prices for ${symbol}:`, error);
                return [];
            }
        }
        function createTradingViewWidget(symbol) {
            const widgetContainer = document.getElementById('tradingview-widget');
            widgetContainer.innerHTML = '';
            new TradingView.MediumWidget({
                symbols: [[symbol]],
                chartOnly: false,
                width: "100%",
                height: 400,
                locale: currentLang,
                colorTheme: "dark",
                gridLineColor: "#F0F3FA",
                trendLineColor: "#2196F3",
                fontColor: "#787B86",
                underLineColor: "rgba(55, 166, 239, 0.15)",
                isTransparent: true,
                autosize: true,
                container_id: "tradingview-widget"
            });
        }
        async function buyStock() {
            if (isBuying) return;
            isBuying = true;
            const buyButton = document.getElementById('buy-button');
            buyButton.disabled = true;
            displayLoader(true);
            const symbolInput = document.getElementById('stock-symbol').value.trim();
            const quantityInput = document.getElementById('quantity').value;
            const symbol = symbolInput.toUpperCase();
            const quantity = parseInt(quantityInput);
            if (!symbol) {
                displayErrorMessage(translations[currentLang].error_stock_symbol);
                isBuying = false;
                buyButton.disabled = false;
                displayLoader(false);
                return;
            }
            if (!quantity || quantity <= 0 || isNaN(quantity)) {
                displayErrorMessage(translations[currentLang].error_quantity);
                isBuying = false;
                buyButton.disabled = false;
                displayLoader(false);
                return;
            }
            try {
                const price = await fetchStockPrice(symbol);
                if (price <= 0) {
                    displayErrorMessage(translations[currentLang].error_invalid_symbol);
                    isBuying = false;
                    buyButton.disabled = false;
                    displayLoader(false);
                    return;
                }
                const totalCost = price * quantity;
                if (totalCost > budget) {
                    displayErrorMessage(translations[currentLang].error_insufficient_cash);
                    isBuying = false;
                    buyButton.disabled = false;
                    displayLoader(false);
                    return;
                }
                budget -= totalCost;
                if (portfolio[symbol]) {
                    portfolio[symbol].quantity += quantity;
                    portfolio[symbol].totalInvested += totalCost;
                } else {
                    portfolio[symbol] = {
                        quantity: quantity,
                        totalInvested: totalCost
                    };
                }
                updateBudget();
                await updatePortfolioTable();
                sendPortfolioUpdate();
                saveUserData();
                updatePortfolioAnalysis();
                displaySuccessMessage(translations[currentLang].success_buy_stock.replace('{quantity}', quantity).replace('{symbol}', symbol));
                console.log(`Bought: ${quantity} shares of ${symbol} at $${price.toFixed(2)} each.`);
            } catch (error) {
                console.error("Error buying stock:", error);
                displayErrorMessage(translations[currentLang].error_buy_stock);
            } finally {
                isBuying = false;
                buyButton.disabled = false;
                displayLoader(false);
            }
        }
        async function sellStock(symbol) {
            symbol = symbol.toUpperCase();
            const totalQuantity = getTotalQuantity(symbol);
            const quantityToSellStr = prompt(translations[currentLang].sell_prompt.replace('{totalQuantity}', totalQuantity), totalQuantity);
            if (quantityToSellStr === null) return;
            const quantityToSell = parseInt(quantityToSellStr);
            if (!quantityToSell || quantityToSell <= 0 || isNaN(quantityToSell)) {
                displayErrorMessage(translations[currentLang].error_quantity);
                return;
            }
            if (quantityToSell > totalQuantity) {
                displayErrorMessage(translations[currentLang].error_insufficient_shares);
                return;
            }
            await sellStockWithQuantity(symbol, quantityToSell);
        }
        async function sellStockWithQuantity(symbol, quantity) {
            symbol = symbol.toUpperCase();
            if (!portfolio[symbol] || getTotalQuantity(symbol) < quantity) {
                displayErrorMessage(translations[currentLang].error_insufficient_shares);
                return;
            }
            try {
                const price = await fetchStockPrice(symbol);
                if (price <= 0) {
                    displayErrorMessage(translations[currentLang].error_invalid_symbol);
                    return;
                }
                const totalRevenue = price * quantity;
                budget += totalRevenue;
                const purchasePrice = portfolio[symbol].totalInvested / portfolio[symbol].quantity;
                portfolio[symbol].quantity -= quantity;
                portfolio[symbol].totalInvested -= purchasePrice * quantity;
                if (portfolio[symbol].quantity === 0) {
                    delete portfolio[symbol];
                }
                updateBudget();
                await updatePortfolioTable();
                sendPortfolioUpdate();
                saveUserData();
                updatePortfolioAnalysis();
                displaySuccessMessage(translations[currentLang].success_sell_stock.replace('{quantity}', quantity).replace('{symbol}', symbol));
                console.log(`Sold: ${quantity} shares of ${symbol} at $${price.toFixed(2)} each.`);
            } catch (error) {
                console.error("Error selling stock:", error);
                displayErrorMessage(translations[currentLang].error_sell_stock);
            }
        }
        function getTotalQuantity(symbol) {
            symbol = symbol.toUpperCase();
            return portfolio[symbol] ? portfolio[symbol].quantity : 0;
        }
        function updateBudget() {
            document.getElementById('budget').innerText = budget.toFixed(2);
            calculateTotalProfit();
        }
        async function updatePortfolioTable() {
            const tbody = document.getElementById('portfolioTableBody');
            tbody.innerHTML = '';
            let totalPortfolioValue = 0;
            let totalProfit = 0;
            const symbols = Object.keys(portfolio);
            const pricePromises = symbols.map(symbol => fetchStockPrice(symbol));
            const prices = await Promise.all(pricePromises);
            symbols.forEach((symbol, index) => {
                const stockData = portfolio[symbol];
                const totalQuantity = stockData.quantity;
                const purchasePrice = stockData.totalInvested / totalQuantity;
                const currentPrice = prices[index];
                const totalCurrentValue = currentPrice * totalQuantity;
                const profit = (currentPrice - purchasePrice) * totalQuantity;
                const percentageProfit = purchasePrice > 0 ? ((currentPrice - purchasePrice) / purchasePrice) * 100 : 0;
                const row = document.createElement('tr');
                const symbolCell = document.createElement('td');
                symbolCell.innerText = symbol;
                row.appendChild(symbolCell);
                const quantityCell = document.createElement('td');
                quantityCell.innerText = totalQuantity;
                row.appendChild(quantityCell);
                const purchasePriceCell = document.createElement('td');
                purchasePriceCell.innerText = `$${purchasePrice.toFixed(2)}`;
                row.appendChild(purchasePriceCell);
                const currentPriceCell = document.createElement('td');
                currentPriceCell.innerText = `$${currentPrice.toFixed(2)}`;
                row.appendChild(currentPriceCell);
                const profitCell = document.createElement('td');
                profitCell.innerHTML = `$${profit.toFixed(2)} (${percentageProfit.toFixed(2)}%)`;
                profitCell.classList.add(profit >= 0 ? 'profit-positive' : 'profit-negative');
                row.appendChild(profitCell);
                const actionCell = document.createElement('td');
                const sellButton = document.createElement('button');
                sellButton.innerText = translations[currentLang].action;
                sellButton.onclick = () => sellStock(symbol);
                actionCell.appendChild(sellButton);
                row.appendChild(actionCell);
                tbody.appendChild(row);
                totalPortfolioValue += totalCurrentValue;
                totalProfit += profit;
            });
            document.getElementById('portfolioValue').innerText = (budget + totalPortfolioValue).toFixed(2);
            document.getElementById('totalProfit').innerText = `$${totalProfit.toFixed(2)}`;
            document.getElementById('totalProfit').classList.remove('profit-positive', 'profit-negative');
            document.getElementById('totalProfit').classList.add(totalProfit >= 0 ? 'profit-positive' : 'profit-negative');
            calculateTotalProfit();
        }
        async function calculateTotalProfit() {
            let totalProfit = 0;
            let totalPortfolioValue = 0;
            const symbols = Object.keys(portfolio);
            const pricePromises = symbols.map(symbol => fetchStockPrice(symbol));
            const prices = await Promise.all(pricePromises);
            symbols.forEach((symbol, index) => {
                const stockData = portfolio[symbol];
                const totalQuantity = stockData.quantity;
                const purchasePrice = stockData.totalInvested / totalQuantity;
                const currentPrice = prices[index];
                const profit = (currentPrice - purchasePrice) * totalQuantity;
                totalProfit += profit;
                totalPortfolioValue += currentPrice * totalQuantity;
            });
            document.getElementById('totalProfit').innerText = `$${totalProfit.toFixed(2)}`;
            document.getElementById('totalProfit').classList.remove('profit-positive', 'profit-negative');
            document.getElementById('totalProfit').classList.add(totalProfit >= 0 ? 'profit-positive' : 'profit-negative');
            document.getElementById('portfolioValue').innerText = (budget + totalPortfolioValue).toFixed(2);
            const totalProfitAmount = (budget + totalPortfolioValue) - initialCapital;
            const percent = initialCapital > 0 ? (totalProfitAmount / initialCapital) * 100 : 0;
            document.getElementById('totalProfitPercent').innerText = `${percent.toFixed(2)}%`;
            document.getElementById('totalProfitPercent').classList.remove('profit-positive', 'profit-negative');
            document.getElementById('totalProfitPercent').classList.add(percent >= 0 ? 'profit-positive' : 'profit-negative');
        }
        function createFallbackCharts() {
            const contexts = ['allocation-chart', 'sector-chart', 'performance-chart', 'profit-loss-chart', 'sparkline-chart'];
            contexts.forEach(id => {
                try {
                    const ctx = document.getElementById(id)?.getContext('2d');
                    if (ctx) {
                        new Chart(ctx, {
                            type: id === 'sparkline-chart' ? 'line' : 'bar',
                            data: {
                                labels: [translations[currentLang].cash_balance],
                                datasets: [{
                                    data: [budget],
                                    backgroundColor: '#007bff',
                                    borderColor: '#007bff',
                                    fill: id === 'sparkline-chart'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: () => `${translations[currentLang].cash_balance}: $${budget.toFixed(2)}`
                                        }
                                    }
                                },
                                scales: {
                                    x: { display: id !== 'sparkline-chart', ticks: { color: '#ffffff' } },
                                    y: { 
                                        display: id !== 'sparkline-chart', 
                                        ticks: { color: '#ffffff', callback: value => '$' + value.toFixed(2) },
                                        grid: { color: '#2e2e2e' }
                                    }
                                }
                            }
                        });
                    }
                } catch (e) {
                    console.error(`Failed to create fallback chart for ${id}:`, e);
                }
            });
        }
        async function updatePortfolioAnalysis() {
            try {
                console.log("Updating portfolio analysis...");
                const symbols = Object.keys(portfolio);
                let totalPortfolioValue = 0;
                const stockValues = [];
                const historicalData = {};
                
                if (symbols.length > 0) {
                    const pricePromises = symbols.map(symbol => fetchStockPrice(symbol));
                    const historicalPromises = symbols.map(symbol => fetchHistoricalPrices(symbol));
                    const prices = await Promise.all(pricePromises);
                    const historicalResults = await Promise.all(historicalPromises);
                    
                    symbols.forEach((symbol, index) => {
                        const stockData = portfolio[symbol];
                        const currentPrice = prices[index];
                        const value = stockData.quantity * currentPrice;
                        if (!isNaN(value) && value >= 0 && currentPrice > 0) {
                            totalPortfolioValue += value;
                            stockValues.push({
                                symbol,
                                value,
                                price: currentPrice,
                                quantity: stockData.quantity,
                                totalInvested: stockData.totalInvested,
                                sector: stockSectors[symbol] || translations[currentLang].unknown
                            });
                            historicalData[symbol] = historicalResults[index];
                        }
                    });
                }
                
                const totalValueWithCash = totalPortfolioValue + budget;
                if (stockValues.length === 0) {
                    stockValues.push({
                        symbol: translations[currentLang].cash_balance,
                        value: budget,
                        price: budget,
                        quantity: 1,
                        totalInvested: budget,
                        sector: translations[currentLang].cash_balance
                    });
                }
                
                console.log("Stock values:", stockValues);
                console.log("Total portfolio value (excluding cash):", totalPortfolioValue);
                
                if (allocationChart) allocationChart.destroy();
                const allocationCtx = document.getElementById('allocation-chart')?.getContext('2d');
                if (!allocationCtx) {
                    console.error("Allocation chart canvas not found");
                    createFallbackCharts();
                    return;
                }
                allocationChart = new Chart(allocationCtx, {
                    type: 'pie',
                    data: {
                        labels: stockValues.map(s => s.symbol),
                        datasets: [{
                            data: stockValues.map(s => s.value),
                            backgroundColor: stockValues.length > 0 ? chartColors.slice(0, stockValues.length) : ['#cccccc'],
                            borderColor: '#1B2631',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#ffffff', font: { size: 12, family: 'Poppins' } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const percentage = totalValueWithCash > 0 ? ((value / totalValueWithCash) * 100).toFixed(2) : 0;
                                        return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log("Allocation chart rendered");
                
                if (sectorChart) sectorChart.destroy();
                const sectorCtx = document.getElementById('sector-chart')?.getContext('2d');
                if (!sectorCtx) {
                    console.error("Sector chart canvas not found");
                    createFallbackCharts();
                    return;
                }
                const sectorData = {};
                stockValues.forEach(stock => {
                    const sector = stock.sector;
                    sectorData[sector] = (sectorData[sector] || 0) + stock.value;
                });
                const sectorLabels = Object.keys(sectorData);
                sectorChart = new Chart(sectorCtx, {
                    type: 'doughnut',
                    data: {
                        labels: sectorLabels,
                        datasets: [{
                            data: Object.values(sectorData),
                            backgroundColor: sectorLabels.length > 0 ? chartColors.slice(0, sectorLabels.length) : ['#cccccc'],
                            borderColor: '#1B2631',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#ffffff', font: { size: 12, family: 'Poppins' } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const percentage = totalValueWithCash > 0 ? ((value / totalValueWithCash) * 100).toFixed(2) : 0;
                                        return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log("Sector chart rendered");
                
                if (performanceChart) performanceChart.destroy();
                const perfCtx = document.getElementById('performance-chart')?.getContext('2d');
                if (!perfCtx) {
                    console.error("Performance chart canvas not found");
                    createFallbackCharts();
                    return;
                }
                
                const days = 30;
                const labels = [];
                const portfolioValues = [];
                const today = new Date();
                const dateSet = new Set();
                
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    const dateStr = date.toLocaleDateString();
                    labels.push(dateStr);
                    let dailyValue = budget;
                    symbols.forEach(symbol => {
                        const stockData = portfolio[symbol];
                        const historicalPrices = historicalData[symbol] || [];
                        const historicalPrice = historicalPrices.find(h => h.date === dateStr)?.price || 
                            (stockData.totalInvested / stockData.quantity);
                        dailyValue += historicalPrice * stockData.quantity;
                    });
                    portfolioValues.push(dailyValue);
                    dateSet.add(dateStr);
                }
                
                performanceChart = new Chart(perfCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: translations[currentLang].portfolio_development,
                            data: portfolioValues,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { 
                                ticks: { color: '#ffffff', maxTicksLimit: 10 }, 
                                grid: { color: '#2e2e2e' } 
                            },
                            y: {
                                ticks: {
                                    color: '#ffffff',
                                    callback: value => '$' + value.toFixed(2)
                                },
                                grid: { color: '#2e2e2e' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#ffffff', font: { family: 'Poppins' } } },
                            tooltip: {
                                callbacks: {
                                    label: context => `${translations[currentLang].portfolio_development}: $${context.raw.toFixed(2)}`
                                }
                            }
                        }
                    }
                });
                console.log("Performance chart rendered");
                
                if (profitLossChart) profitLossChart.destroy();
                const plCtx = document.getElementById('profit-loss-chart')?.getContext('2d');
                if (!plCtx) {
                    console.error("Profit/loss chart canvas not found");
                    createFallbackCharts();
                    return;
                }
                const validStocks = stockValues.filter(stock => stock.symbol !== translations[currentLang].cash_balance);
                const plData = validStocks.map(stock => {
                    const purchasePrice = stock.totalInvested / stock.quantity;
                    return (stock.price - purchasePrice) * stock.quantity;
                });
                profitLossChart = new Chart(plCtx, {
                    type: 'bar',
                    data: {
                        labels: validStocks.map(s => s.symbol),
                        datasets: [{
                            label: translations[currentLang].profit_loss_per_stock,
                            data: plData,
                            backgroundColor: plData.map(value => value >= 0 ? '#4caf50' : '#f44336'),
                            borderColor: '#1B2631',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { ticks: { color: '#ffffff' }, grid: { display: false } },
                            y: {
                                ticks: {
                                    color: '#ffffff',
                                    callback: value => '$' + value.toFixed(2)
                                },
                                grid: { color: '#2e2e2e' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#ffffff', font: { family: 'Poppins' } } },
                            tooltip: {
                                callbacks: {
                                    label: context => `${translations[currentLang].profit_loss}: $${context.raw.toFixed(2)}`
                                }
                            }
                        }
                    }
                });
                console.log("Profit/loss chart rendered");
                
                const topPerformer = validStocks.reduce((max, stock) => {
                    const purchasePrice = stock.totalInvested / stock.quantity;
                    const profitPercent = purchasePrice > 0 ? ((stock.price - purchasePrice) / purchasePrice) * 100 : 0;
                    return !max || profitPercent > max.profitPercent ? { symbol: stock.symbol, profitPercent } : max;
                }, null);
                const worstPerformer = validStocks.reduce((min, stock) => {
                    const purchasePrice = stock.totalInvested / stock.quantity;
                    const profitPercent = purchasePrice > 0 ? ((stock.price - purchasePrice) / purchasePrice) * 100 : 0;
                    return !min || profitPercent < min.profitPercent ? { symbol: stock.symbol, profitPercent } : min;
                }, null);
                const largestPosition = validStocks.reduce((max, stock) => {
                    return !max || stock.value > max.value ? stock : max;
                }, null);
                
                document.getElementById('top-performer').innerText = topPerformer && topPerformer.profitPercent !== 0 ? 
                    `${topPerformer.symbol} (${topPerformer.profitPercent.toFixed(2)}%)` : '-';
                document.getElementById('worst-performer').innerText = worstPerformer && worstPerformer.profitPercent !== 0 ? 
                    `${worstPerformer.symbol} (${worstPerformer.profitPercent.toFixed(2)}%)` : '-';
                document.getElementById('largest-position').innerText = largestPosition ? 
                    `${largestPosition.symbol} ($${largestPosition.value.toFixed(2)})` : '-';
                document.getElementById('position-count').innerText = validStocks.length;
                document.getElementById('avg-position-size').innerText = validStocks.length > 0 ? 
                    `$${(totalPortfolioValue / validStocks.length).toFixed(2)}` : '$0.00';
                
                if (sparklineChart) sparklineChart.destroy();
                const sparklineCtx = document.getElementById('sparkline-chart')?.getContext('2d');
                if (!sparklineCtx) {
                    console.error("Sparkline chart canvas not found");
                    createFallbackCharts();
                    return;
                }
                const sparklineData = portfolioValues.slice(-10).length > 0 ? portfolioValues.slice(-10) : [budget, budget];
                const sparklineLabels = labels.slice(-10).length > 0 ? labels.slice(-10) : ['Start', 'End'];
                sparklineChart = new Chart(sparklineCtx, {
                    type: 'line',
                    data: {
                        labels: sparklineLabels,
                        datasets: [{
                            data: sparklineData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        }
                    }
                });
                console.log("Sparkline chart rendered");
            } catch (error) {
                console.error("Portfolio analysis failed:", error);
                createFallbackCharts();
                displayErrorMessage(translations[currentLang].error_fetch_stock_list);
            }
        }
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                this.classList.add('active');
                const tabContent = document.getElementById(`${tabName}-tab`);
                if (tabContent) {
                    tabContent.classList.add('active');
                } else {
                    console.error(`Tab content not found for: ${tabName}`);
                }
            });
        });
        function normalizePortfolioSymbols(originalPortfolio) {
            const normalizedPortfolio = {};
            for (const symbol in originalPortfolio) {
                const upperSymbol = symbol.toUpperCase();
                if (!normalizedPortfolio[upperSymbol]) {
                    normalizedPortfolio[upperSymbol] = {
                        quantity: 0,
                        totalInvested: 0
                    };
                }
                normalizedPortfolio[upperSymbol].quantity += originalPortfolio[symbol].quantity;
                normalizedPortfolio[upperSymbol].totalInvested += originalPortfolio[symbol].totalInvested;
            }
            return normalizedPortfolio;
        }
        function displaySuccessMessage(message) {
            displayMessage(message, 'success');
        }
        function displayErrorMessage(message) {
            displayMessage(message, 'error');
        }
        function displayMessage(message, type) {
            const container = document.getElementById('message-container');
            const div = document.createElement('div');
            div.classList.add('message', type);
            div.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }
        function displayLoader(show) {
            const loader = document.getElementById('loader');
            loader.style.display = show ? 'block' : 'none';
        }
        function saveUserData() {
            const user = firebase.auth().currentUser;
            if (user) {
                const userId = user.uid;
                const userRef = database.ref('users/' + userId);
                userRef.set({
                    budget: budget,
                    portfolio: portfolio
                }, (error) => {
                    if (error) {
                        console.error("Error saving data:", error);
                        displayErrorMessage("Error saving user data.");
                    } else {
                        console.log("Data saved successfully.");
                    }
                });
            }
        }
        window.onload = async function() {
            console.log("Window loaded, initializing...");
            showWelcomePopup();
            createTradingViewWidget('AAPL');
            currentSymbol = 'AAPL';
            await fetchStockList();
            updatePortfolioAnalysis();
        };
    </script>
</body>
</html>